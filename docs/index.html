<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Analyzing Github followers of Dr. R. Raja Subramanian</title>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.min.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    </head>
    <body>
        <header>
            <h1>Data Viz - Github followers of Dr. R. Raja Subramanian</h1>
        </header>
        <main>
            <article>
                    <h2>What are his followers most interested in?</h2>
                    <h3>#1 - WORD CLOUD </h3>
                    <p>Word cloud obtained from the repo names of his followers</p>
                <div id="word-cloud">
                </div>
            </article>
            <article>
                    <h3>#2 - WORD CHART</h3>
                    <p>Top 20 Words</p>
                <svg width="600" height="600" id="wordChart"></svg>
            </article>
        </main>
</body>
<script>

// Custom Color Scales
var colorScale = d3.scaleOrdinal(d3.schemeCategory10); // Predefined color scale
 var pastelColorScale = d3.scaleOrdinal()
    .range([
 /* CSS HEX */
"#001219ff",
"#005f73ff",
"#0a9396ff",
"#94d2bdff",
"#e9d8a6ff",
"#ee9b00ff",
"#ca6702ff",
"#bb3e03ff",
"#ae2012ff",
"#9b2226ff"
    ]);
 function createBarChart(sortedObj) {
    // Select top 10 key-value pairs
    const top10Entries = Object.entries(sortedObj).slice(0, 20);

    // Set up SVG dimensions
     var svg = d3.select("#wordChart"),
        margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;


    // Create scales
    const xScale = d3.scaleBand()
        .domain(top10Entries.map(d => d[0]))
        .range([margin.left, width - margin.right])
        .padding(0.1);

    const yScale = d3.scaleLinear()
        .domain([0, d3.max(top10Entries, d => d[1])])
        .range([height - margin.bottom, margin.top]);

    // Add bars
    svg.append("g")
        .selectAll("rect")
        .data(top10Entries)
        .join("rect")
        .attr("x", d => xScale(d[0]))
        .attr("y", d => yScale(d[1]))
        .attr("height", d => yScale(0) - yScale(d[1]))
        .attr("width", xScale.bandwidth())
        .attr("fill", "#94d2bd");

  // Add X axis with rotated labels
    svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(xScale))
        .selectAll("text")
        .attr("transform", "translate(-10,0)rotate(-45)")
        .attr("font-family", "Roboto, sans-serif")
        .attr("font-size", "0.8rem")
        .style("text-anchor", "end");
    // Add Y axis
    svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(yScale));
}


 function drawWordCloud(wordCloudData) {
    var width = 600;
    var height = 600;
    var layout = d3.layout.cloud()
        .size([width, height])
        .words(wordCloudData.map(function(d) {
            return {text: d.word, size: d.size * 10};
        }))
        .padding(5)
        .rotate(0)
        .fontSize(d => d.size)
        .on("end", draw);

    layout.start();

    function draw(words) {
        d3.select("#word-cloud").append("svg")
            .attr("width", layout.size()[0])
            .attr("height", layout.size()[1])
            .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
            .selectAll("text")
            .data(words)
            .enter().append("text")
            .style("font-size", d => d.size + "px")
            .style("fill", function(d) { return pastelColorScale(d.size); }) // Apply color
            .attr("text-anchor", "middle")
            .attr("transform", d => "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")")
            .text(d => d.text);
    }
}


function countWordOccurrences(wordsArray) {
    var count = {};
    wordsArray.forEach(function(word) {
        word = word.toLowerCase(); // Convert to lower case
        count[word] = (count[word] || 0) + 1;
    });
    return count;
}

// Fetch Data and create charts
 fetch('/gt_followers/words.json')
    .then(response => response.json())
    .then(words => {
        // Process your words here
        var wordCounts = countWordOccurrences(words);

        var wordCloudData = Object.keys(wordCounts).map(function(key) {
            return { word: key, size: wordCounts[key] };
        });
        drawWordCloud(wordCloudData)
        // Convert object to array and sort it, then slice it
        const wordCountsData = Object.entries(wordCounts).sort((a, b) => b[1] - a[1]).slice(0, 30);

        // Convert back to object
        const sortedWordCounts = Object.fromEntries(wordCountsData);
        console.log(sortedWordCounts)
        createBarChart(sortedWordCounts)
    })
    .catch(error => console.error('Error fetching data:', error));
</script>
</html>
